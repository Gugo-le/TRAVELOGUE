<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAVELOGUE - Ïó¨ÌñâÏùÑ ÏãúÏûëÌïòÎäî ÏàúÍ∞ÑÏùò ÏÑ§Î†ò</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datamaps/0.5.9/datamaps.world.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    
    <!-- Firebase SDK (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <link rel="stylesheet" href="./style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="assets/favicon/favicon.svg">
    <link rel="alternate icon" type="image/png" href="assets/favicon/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
    <link rel="manifest" href="assets/favicon/site.webmanifest">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
<script>
  // Debug: Î¨¥Ìïú ÏÉàÎ°úÍ≥†Ïπ® Î∞©ÏßÄ
  if (performance.navigation.type === 1) {
    console.log('Page reloaded - clearing cache');
    localStorage.removeItem('travelogue-last-visit');
  }
</script>

<audio id="stamp-sound" src="assets/audio/takeoff.m4a"></audio>
<audio id="airplane-bp" src="assets/audio/airplane_bp.m4a"></audio>
<audio id="landing-sound" src="assets/audio/landing.m4a"></audio>
<audio id="airplane-loop" loop src="assets/audio/airplane.m4a"></audio>
<audio id="soundscape-audio" loop></audio>

<div id="intro-window">
    <div id="intro-hero" class="intro-hero">
        <div class="window-frame"><div class="window-glass"><div class="clouds"></div></div></div>
        <div class="intro-text-zone">
            <p class="terminal">TERMINAL 01 ¬∑ GATE 24A</p>
            <p class="main-slogan">Focus Îêú ÏãúÏÑ† ÏúÑÏóêÏÑú ÌùêÎ•¥Í≥†,<br>Î∂ÑÏúÑÍ∏∞Î°ú Í∏∞ÏñµÎêòÎäî Ïó¨Ìñâ ÏßÄÎèÑ</p>
            
            <div id="intro-auth-state" class="intro-auth-state">
                <div class="click-prompt" onclick="showSignUpForm()">NEW TRAVELER</div>
            </div>
        </div>
    </div>

    <div id="signup-section" class="signup-section">
        <div class="auth-box">
            <div class="ticket-header">
                <div class="airline">TRAVELOGUE JOURNEY</div>
                <h1>Boarding Pass</h1>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="auth-form active">
                <div class="route-display">
                    <div class="route-code">SIGN</div>
                    <div class="route-arrow">‚úà</div>
                    <div class="route-code">IN</div>
                </div>

                <div class="form-section">
                    <label class="form-label">Email</label>
                    <input type="email" id="login-email" placeholder="">
                </div>

                <div class="form-section">
                    <label class="form-label">Password</label>
                    <input type="password" id="login-password" placeholder="">
                </div>

                <button onclick="handleIntroEmailSignIn()">Begin Journey</button>

                <div class="divider">or continue with</div>

                <button type="button" class="social-btn" onclick="handleIntroGoogleSignIn()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 256 262" preserveAspectRatio="xMidYMid">
                        <path d="M255.68 133.5c0-10.6-.92-18.3-2.9-26.3H130.55v47.6h71.9c-1.45 11.8-9.3 29.7-26.8 41.7l-.2 1.3 38.9 30.2 2.7.3c24.8-22.9 39.3-56.6 39.3-95.3" fill="#4285F4"></path>
                        <path d="M130.55 261.1c35.7 0 65.7-11.7 87.6-31.8l-41.7-32.4c-11.2 7.8-26.1 13.3-45.9 13.3-35 0-64.8-22.9-75.4-54.6l-1.3.1-40.8 31.6-.5 1.2c21.9 43.6 66.8 72.6 118 72.6" fill="#34A853"></path>
                        <path d="M55.15 155.6c-2.8-8.1-4.4-16.7-4.4-25.6 0-8.9 1.6-17.5 4.2-25.6l-.1-1.7-41.3-32-.6 1.1C4.2 90.5 0 107.2 0 124.9c0 17.7 4.2 34.4 12.9 52.7" fill="#FBBC05"></path>
                        <path d="M130.55 50.5c24.8 0 41.5 10.7 51 19.6l37.2-36.3C196.15 12.1 166.25 0 130.55 0 79.35 0 34.45 29 12.85 72.2l42.1 32.3c10.6-31.7 40.4-54 75.6-54" fill="#EB4335"></path>
                    </svg>
                    Google
                </button>

                <div id="login-error" class="error"></div>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="auth-form">
                <div class="route-display">
                    <div class="route-code">JOIN</div>
                    <div class="route-arrow">‚úà</div>
                    <div class="route-code">US</div>
                </div>

                <div class="form-section">
                    <label class="form-label">Name</label>
                    <input type="text" id="intro-name" placeholder="">
                </div>

                <div class="form-section">
                    <label class="form-label">Email</label>
                    <input type="email" id="intro-email" placeholder="">
                </div>

                <div class="form-section">
                    <label class="form-label">Password</label>
                    <input type="password" id="intro-password" placeholder="">
                </div>

                <button onclick="handleIntroSignUpSimple()">Start Adventure</button>

                <div class="divider">or continue with</div>

                <button type="button" class="social-btn" onclick="handleIntroGoogleSignIn()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 256 262" preserveAspectRatio="xMidYMid">
                        <path d="M255.68 133.5c0-10.6-.92-18.3-2.9-26.3H130.55v47.6h71.9c-1.45 11.8-9.3 29.7-26.8 41.7l-.2 1.3 38.9 30.2 2.7.3c24.8-22.9 39.3-56.6 39.3-95.3" fill="#4285F4"></path>
                        <path d="M130.55 261.1c35.7 0 65.7-11.7 87.6-31.8l-41.7-32.4c-11.2 7.8-26.1 13.3-45.9 13.3-35 0-64.8-22.9-75.4-54.6l-1.3.1-40.8 31.6-.5 1.2c21.9 43.6 66.8 72.6 118 72.6" fill="#34A853"></path>
                        <path d="M55.15 155.6c-2.8-8.1-4.4-16.7-4.4-25.6 0-8.9 1.6-17.5 4.2-25.6l-.1-1.7-41.3-32-.6 1.1C4.2 90.5 0 107.2 0 124.9c0 17.7 4.2 34.4 12.9 52.7" fill="#FBBC05"></path>
                        <path d="M130.55 50.5c24.8 0 41.5 10.7 51 19.6l37.2-36.3C196.15 12.1 166.25 0 130.55 0 79.35 0 34.45 29 12.85 72.2l42.1 32.3c10.6-31.7 40.4-54 75.6-54" fill="#EB4335"></path>
                    </svg>
                    Google
                </button>

                <div id="intro-auth-error" class="error"></div>
            </div>

            <div class="ticket-footer">
                <p class="auth-toggle" id="auth-toggle-text">
                    <a href="#" onclick="toggleIntroAuthForm(event)">New Ticket?</a>
                </p>
                <div class="boarding-pass">TRV-2026</div>
            </div>
        </div>
    </div>

    <div id="checkin-section" class="checkin-section">
        <div class="auth-box">
            <div class="ticket-header">
                <div class="airline">TRAVELOGUE JOURNEY</div>
                <h1>Boarding Pass</h1>
            </div>

            <div class="checkin-form">
                <div class="route-display">
                    <div class="route-code">CHECK</div>
                    <div class="route-arrow">‚úà</div>
                    <div class="route-code">IN</div>
                </div>

                <div class="checkin-inputs">
                    <div class="form-section">
                        <label class="form-label">Passenger Name</label>
                        <input type="text" id="input-name" placeholder="" oninput="syncCustom()">
                    </div>
                    <div class="form-section">
                        <label class="form-label">Departing From</label>
                        <input type="text" id="input-from" placeholder="" oninput="syncCustom()">
                    </div>
                </div>

                <button onclick="startJourney()">Begin Journey</button>
            </div>

            <div class="ticket-footer">
                <p class="auth-toggle"></p>
                <div class="boarding-pass">TRV-2026</div>
            </div>
        </div>
    </div>
</div>

<div id="main-content" class="active">
    <div id="subtitle-container">
        <div class="flip-board" id="flip-board"></div>
    </div>
    <div id="journey-summary" aria-hidden="true">
        <div class="summary-header">
            <span class="tag">TRAVELOGUE</span>
            <span>JOURNEY STATS</span>
        </div>
        <div class="journey-summary-body">
            <div class="journey-summary-row"><span class="label">TRIPS</span><span class="value" id="journey-summary-trips">0</span></div>
            <div class="journey-summary-row"><span class="label">TOP</span><span class="value" id="journey-summary-top">---</span></div>
            <div class="journey-summary-row"><span class="label">DIST</span><span class="value" id="journey-summary-dist">0 KM</span></div>
            <div class="journey-summary-row"><span class="label">AVG</span><span class="value" id="journey-summary-avg">0 KM</span></div>
        </div>
    </div>

    <div id="passport-btn" onclick="togglePassport()"></div>

    <div id="passport-overlay" onclick="togglePassport()">
        <button class="passport-nav prev" id="passport-prev" onclick="changePassportPage(-1); event.stopPropagation();" aria-label="Previous page">‚Üê</button>
        <div id="passport-summary" class="passport-summary" onclick="event.stopPropagation()"></div>
        <div class="passport-page" id="passport-page" onclick="event.stopPropagation()"></div>
        <button class="passport-nav next" id="passport-next" onclick="changePassportPage(1); event.stopPropagation();" aria-label="Next page">‚Üí</button>
    </div>

    <div id="boarding-pass-ui" onclick="handleTicketClick(event)">
        <div class="ticket-main">
            <div class="ticket-header">
                <div class="brand-box"><div class="brand">TRAVELOGUE JOURNEY</div><div class="sub">ROK INTERNATIONAL</div></div>
                <div class="ticket-flight">
                    <div class="ticket-flight-label">FLIGHT</div>
                    <div class="ticket-flight-code">TRV-2026</div>
                </div>
            </div>
            <div class="route" id="route-line">
                <input class="city-code city-code-input" id="ticket-from-code" list="airport-list-all" value="ICN" maxlength="3" aria-label="From airport" autocapitalize="characters" spellcheck="false">
                <div class="plane-path"></div>
                <input class="city-code city-code-input" id="ticket-dest-code" list="airport-list-dest" placeholder="---" maxlength="3" aria-label="To airport" autocapitalize="characters" spellcheck="false">
            </div>
            <datalist id="airport-list-all"></datalist>
            <datalist id="airport-list-dest"></datalist>
            <div class="meta-grid">
                <div class="meta-item"><div class="label">Passenger</div><div class="val" id="ticket-name">---</div></div>
                <div class="meta-item"><div class="label">Date</div><input type="text" id="ticket-date" class="ticket-input" placeholder="YYYY-MM-DD" autocomplete="off" inputmode="none" readonly></div>
                <div class="meta-item"><div class="label">Seat</div><input type="text" id="ticket-seat" class="ticket-input" value="12A"></div>
                <div class="meta-item"><div class="label">Class</div>
                    <select id="ticket-class" class="ticket-input">
                        <option value="ECONOMY" selected>ECONOMY</option>
                        <option value="BUSINESS">BUSINESS</option>
                        <option value="FIRST">FIRST</option>
                    </select>
                </div>
            </div>
            <div id="visit-history" class="visit-history">FIRST VISIT</div>
        </div>
        <div class="ticket-stub">
            <div class="ticket-stub-header">
                <div class="ticket-stub-label">BOARDING PASS</div>
                <div class="ticket-stub-seat" id="ticket-seat-stub">12A</div>
            </div>
            <div class="qr-section-stub">
                <div class="barcode" aria-label="Boarding pass barcode"></div>
            </div>
            <div class="ticket-stub-hash">#TRAVELOGUE_026</div>
        </div>
    </div>

    <button id="back-btn" onclick="resetMap()">‚Üê WORLD</button>
    <div id="map-mode-toggle" role="group" aria-label="Map view">
        <button type="button" class="map-mode-btn" data-mode="flat" aria-pressed="true">FLAT</button>
        <button type="button" class="map-mode-btn" data-mode="globe" aria-pressed="false">GLOBE</button>
    </div>
    <div class="hero-overlay" id="hero">
        <h1>TRAVELOGUE</h1>
        <p>WHERE TO NEXT?</p>
    </div>
    <div id="flight-status">FLIGHT TRV-2026 ¬∑ BOARDING ¬∑ 12A</div>
    <div id="event-hud" aria-hidden="true">
        <div class="event-row">
            <div class="boarding-anim">BOARDING<span class="dots"><span>.</span><span>.</span><span>.</span></span></div>
            <div class="status-stamp" id="status-stamp">BOARDING</div>
        </div>
        <div class="progress-line">
            <span class="code" id="hud-from">ICN</span>
            <span class="line"></span>
            <span class="code" id="hud-to">---</span>
        </div>
        <div class="timeline" id="timeline">
            <span class="step" data-step="checkin">CHECK-IN</span>
            <span class="step" data-step="boarding">BOARDING</span>
            <span class="step" data-step="taxi">TAXI</span>
            <span class="step" data-step="takeoff">TAKEOFF</span>
        </div>
        <div class="countdown">GATE 24A ¬∑ <span id="countdown">T-00:23</span></div>
    </div>
    <div id="map-wrapper"></div>
</div>

<!-- Bottom Navigation Bar -->
<nav id="bottom-nav" class="bottom-nav">
    <a href="#" class="nav-item active" data-page="home" title="Home">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span class="nav-label">Home</span>
    </a>
    <a href="search.html" class="nav-item" data-page="search" title="Search">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <span class="nav-label">Search</span>
    </a>
    <a href="friends.html" class="nav-item" title="Friends">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span class="nav-label">Friends</span>
    </a>
    <a href="profile.html" class="nav-item" title="Profile">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span class="nav-label">Profile</span>
    </a>
</nav>

<!-- QR Modal -->
<div id="qr-modal" class="modal" style="display: none;">
    <div class="modal-content qr-modal-content">
        <button class="modal-close" onclick="closeQRModal()">‚úï</button>
        
        <div class="qr-tabs">
            <button class="qr-tab active" onclick="switchQRTab('show')">Show My QR</button>
            <button class="qr-tab" onclick="switchQRTab('scan')">Scan QR</button>
        </div>

        <!-- Show QR Tab -->
        <div id="show-qr-tab" class="qr-tab-content active">
            <div class="qr-display-container">
                <p class="qr-instruction">Share this QR code to let friends add you</p>
                <div id="qr-code-display" class="qr-code-display"></div>
                <button class="button-primary" onclick="downloadQRCode()">
                    üì• Download QR
                </button>
            </div>
        </div>

        <!-- Scan QR Tab -->
        <div id="scan-qr-tab" class="qr-tab-content" style="display: none;">
            <div class="qr-scanner-container">
                <p class="qr-instruction">Point camera at a QR code</p>
                <div id="qr-reader" class="qr-reader"></div>
                <p id="scan-result" class="scan-result" style="display: none;"></p>
            </div>
        </div>
    </div>
</div>

<script src="./js/firebaseConfig.js"></script>
<script src="./js/auth.js"></script>
<script src="./js/search.js"></script>
<script src="./js/data.js"></script>
<script src="./js/stats.js"></script>
<script src="./js/trips.js"></script>
<script src="./js/stamps.js"></script>
<script src="./js/userdata.js"></script>
<script src="./js/state.js"></script>
<script src="./js/utils.js"></script>
<script src="./js/audio.js"></script>
<script src="./js/ui.js"></script>
<script src="./js/map.js"></script>
<script src="./js/navigation.js"></script>
<script src="./js/home.js"></script>
<script src="./js/script.js"></script>
<script>
    let isUserAuthenticated = false;

    function toggleIntroAuthForm(e) {
        e.preventDefault();
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleText = document.getElementById('auth-toggle-text');
        
        if (loginForm.classList.contains('active')) {
            loginForm.classList.remove('active');
            signupForm.classList.add('active');
            toggleText.innerHTML = '<a href="#" onclick="toggleIntroAuthForm(event)">Have a Ticket?</a>';
        } else {
            signupForm.classList.remove('active');
            loginForm.classList.add('active');
            toggleText.innerHTML = '<a href="#" onclick="toggleIntroAuthForm(event)">New Ticket?</a>';
        }
    }

    function showSignUpForm() {
        const introWindow = document.getElementById('intro-window');
        introWindow.classList.add('show-signup');
        // Play boarding pass sound only on New Traveler click
        playAudio('airplane-bp');
    }

    function hideSignUpForm() {
        const introWindow = document.getElementById('intro-window');
        introWindow.classList.remove('show-signup');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleText = document.getElementById('auth-toggle-text');
        
        loginForm.classList.add('active');
        signupForm.classList.remove('active');
        toggleText.innerHTML = '<a href="#" onclick="toggleIntroAuthForm(event)">New Ticket?</a>';
        
        document.getElementById('intro-email').value = '';
        document.getElementById('intro-name').value = '';
        document.getElementById('intro-handle').value = '';
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('intro-auth-error').textContent = '';
        document.getElementById('login-error').textContent = '';
    }

    function showCheckInForm() {
        const introWindow = document.getElementById('intro-window');
        introWindow.classList.remove('show-signup');
        introWindow.classList.add('show-checkin');
        isUserAuthenticated = true;
    }

    function showAuthError(message, isLogin = false) {
        const errorEl = document.getElementById(isLogin ? 'login-error' : 'intro-auth-error');
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    }

    async function handleIntroEmailSignIn() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();

        if (!email || !password) {
            showAuthError('Please fill in all fields', true);
            return;
        }

        try {
            const errorEl = document.getElementById('login-error');
            if (errorEl) errorEl.style.display = 'none';
            await signInWithEmail(email, password);
            showCheckInForm();
        } catch (error) {
            console.error('Login error:', error);
            showAuthError(error.message || 'Login failed. Try again.', true);
        }
    }

    async function handleIntroSignUpSimple() {
        const email = document.getElementById('intro-email').value.trim();
        const name = document.getElementById('intro-name').value.trim();
        const password = document.getElementById('intro-password').value.trim();

        if (!email || !name || !password) {
            showAuthError('Please fill in all fields', false);
            return;
        }

        if (password.length < 6) {
            showAuthError('Password must be at least 6 characters', false);
            return;
        }

        // Generate username from name
        const handle = name.toLowerCase().replace(/\s+/g, '') + Math.floor(Math.random() * 1000);

        try {
            const errorEl = document.getElementById('intro-auth-error');
            if (errorEl) errorEl.style.display = 'none';
            await signUpWithEmail(email, password, name, handle);
            showCheckInForm();
        } catch (error) {
            console.error('Signup error:', error);
            showAuthError(error.message || 'Signup failed. Try again.', false);
        }
    }

    async function handleIntroGoogleSignIn() {
        try {
            showAuthError('');
            await signInWithGoogle();
            showCheckInForm();
        } catch (error) {
            console.error('Google signup error:', error);
            showAuthError(error.message || 'Google signup failed. Try again.');
        }
    }

    initializeFirebase();

    let authStateInitialized = false;
    watchAuthState(user => {
        if (authStateInitialized) return; // Prevent re-execution
        
        if (user) {
            console.log('User authenticated:', user.uid);
            authStateInitialized = true;

            if (typeof window.setIntroState === 'function') {
                window.setIntroState(window.__forceIntro === true ? true : false);
            }
            
            if (isUserAuthenticated === false) {
                showCheckInForm();
            }
            if (typeof subscribeHomeStats === 'function') subscribeHomeStats(user.uid);
            
            // Load stamps from Firestore
            if (typeof loadStampsFromFirestore === 'function') {
                loadStampsFromFirestore(user.uid).catch(e => console.warn('Error loading stamps:', e));
            }
            
            // Load all user data from Firestore
            if (typeof loadAllUserDataFromFirestore === 'function') {
                loadAllUserDataFromFirestore(user.uid).catch(e => console.warn('Error loading user data:', e));
            }
            if (typeof syncJourneyRoutesFromTrips === 'function') {
                syncJourneyRoutesFromTrips(user.uid).catch(e => console.warn('Error syncing routes:', e));
            }
        } else {
            if (typeof window.setIntroState === 'function') {
                window.setIntroState(true);
            }
        }
    });
</script>
</body>
</html>
